# 2026-02-02：路线图（按 Phase）

## 总目标

把当前项目演进为“以 CLI 为主”的 Windows 自动化工具集：每类能力可通过命令行单次调用；具备明确的安全策略；每个功能尽量有可重复的测试。

## Phase 0：文档与基线（本阶段必须先完成）

目标：
- 文档齐全：优化清单、路线图、计划、进展、参考。
- 建立“对外契约”基线：CLI 命令格式、输出 JSON schema、错误码约定。

验收：
- `docs/` 结构与索引齐全。
- `docs/reference/` 有可执行命令示例。

## Phase 1：独立 CLI 工程封装（非 MCP）

目标：
- 新建独立 CLI 调度工程（例如 `Windows.Agent.Cli`）。
- CLI 子命令按工具类别拆分（desktop/fs/ocr/sys）。
- CLI 内部通过“调用现有 Tools 类”执行，而不是直接调用 Service。

验收：
- `dotnet run --project <cli> -- help` 可用。
- 至少 1 个 desktop 命令 + 1 个 fs 命令可用。
- 输出 JSON 可解析，错误输出统一格式。

## Phase 2：测试体系与副作用控制

目标：
- CLI 命令解析与调度：纯单测（mock 服务接口）。
- 高危操作：默认禁用，需显式开关（例如 `--dangerous`）。
- 可选 Integration Tests（默认不跑），用于真实桌面验证。

验收：
- `dotnet test` 默认不触发桌面操作且稳定通过（在无 UI 环境也应可跑）。

## Phase 3：下线 MCP Server（必选）

目标：
- 完全移除 MCP 依赖与 `PackageType=McpServer`，只保留 CLI 入口（独立 CLI 工程为主）。
- 移除 `Windows.Agent` 内嵌 Legacy CLI（避免多入口与误用）。

验收：
- 主发布产物为 CLI（dotnet tool 或 `dotnet run --project ...`），不再作为 MCP Server 入口。
- 仓库内不再存在 MCP server.json / MCP 启动入口 / `ModelContextProtocol` 依赖。

## Phase 4：能力增强（UIA/可观测性/性能）

目标：
- UIA：具备可用的控件树/选择器/动作模式（Invoke/Value 等），用于稳定定位与交互。
- UI Contract：对象库（控件库）落地（YAML/JSON 解析、校验、解释），让 AI 的自然语言用例可编译。
- 可观测性：错误分层、证据包（Artifacts）、诊断通道（日志/事件）可管道化采集。
- 性能与稳定：OCR 初始化/缓存/并发与资源释放优化。
- 扩展：浏览器网页自动化作为独立能力规划（Playwright/WebDriver），不强行走 UIA。

验收：
- **UIA 能力**
  - 新增 `desktop uia-tree/uia-find/uia-invoke/uia-setvalue`（命令名可在实现时微调，但需写入命令速查与审计表）。
  - `uia-find` 输出包含：命中元素的 `name/automationId/controlType/boundingRectangle/isEnabled/isOffscreen`（至少这些字段）。
  - 提供 selector 解析单测（不触发桌面操作）。
  - 提供至少 1 个可手动运行的 Integration Test（`Category=Desktop`），验证 `uia-invoke/uia-setvalue` 在测试目标窗口上可用。

- **UI Contract 能力**
  - 支持 YAML/JSON 两种输入。
  - 新增 `contract validate`：能输出缺字段/冲突/无可用定位方式等问题。
  - 新增 `contract explain`：输出窗口/控件/断言摘要，便于审计。
  - 校验与解释具备单测（不触发桌面操作）。

- **错误与证据包（Artifacts）**
  - CLI 输出 schema 版本化：包含 `success/code/message/tool/input/result/error/artifacts/session`（字段可扩展但不可缺失核心字段）。
  - 顶层 `success` 与 exit code 反映“工具真实成败”（不再仅表示“调度成功”）。
  - 支持 `--snapshot-on-error`：失败时自动附带 screenshot + state（作为 artifacts）。

- **诊断通道（Pipeline）**
  - 新增 `diag tail-log`（或等价命令）：可读取指定日志末尾 N 行，输出结构化 JSON。
  - 规划 `diag collect/eventlog`（可分阶段实现）：能按 sessionId 收集证据包到指定目录。

- **OCR 稳定性**
  - 移除阻塞 `.Result` 的初始化路径，改为全链路 `await`，避免死锁/线程池阻塞。
  - 具备并发安全初始化（例如 `Lazy<Task<...>>`）并提供单测覆盖。
