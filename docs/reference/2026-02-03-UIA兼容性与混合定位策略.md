# 2026-02-03：UIA 兼容性与混合定位策略（Windows.Agent）

## 1. 结论（先说清边界）

- **UIA（Windows UI Automation）无法保证兼容所有桌面应用。**
- UIA 的有效性取决于：应用/控件是否提供 UIA Provider（自动化树/可访问性信息）。
- 对 UIA 不完整或缺失的应用，必须采用 **混合定位**：`UIA → OCR → 坐标` 的降级链路。

## 2. 兼容性矩阵（经验型）

> 说明：下表是工程实践经验总结，用于选择策略；实际以你的被测应用 A 的表现为准。

| 应用类型 | UIA 可用性 | 推荐定位方式 | 主要风险/限制 |
|---|---:|---|---|
| WPF / WinUI / UWP | 高 | UIA（AutomationId/Name/ControlType） | 仍可能被主题/动态列表影响，需要稳定 selector |
| WinForms | 中 | UIA + 兜底 OCR | 依赖 Accessible/LegacyIAccessible，AutomationId 可能为空或变化 |
| 传统 Win32（原生控件） | 中 | UIA（部分）+ OCR | 控件树不完整、类名/名称不稳定 |
| Electron（Chromium） | 低~中 | OCR 优先 + 坐标兜底 | UIA 往往只能看到少量节点或顶层窗口 |
| Qt / 自绘（DirectX/OpenGL） | 低 | OCR + 坐标 | UIA 可能几乎不可用；DPI/多屏变化导致坐标漂移 |
| 游戏/全屏渲染 | 很低 | 坐标（强约束）/图像匹配（未来） | 焦点/全屏/反作弊/输入注入限制 |

## 3. 浏览器与网页测试建议

- 浏览器窗口本身通常可被 UIA 识别（窗口/工具栏等），但**网页 DOM 元素不建议靠 UIA 做稳定定位**。
- 对网页自动化测试，推荐：
  - **Playwright（首选）** 或 WebDriver（Selenium）
  - 通过浏览器自动化框架的 selector（CSS/XPath/ARIA）定位 DOM

在 Windows.Agent 的路线图中，建议把“浏览器网页自动化”作为**独立能力**规划，而不是把 UIA 当作网页测试的主手段（见 `docs/plan/2026-02-02-路线图-按阶段.md` 的 Phase 4 拆解）。

## 4. 混合定位策略（推荐默认）

### 4.1 优先级与降级规则

默认策略：`UIA → OCR → 坐标`

- UIA 成功：优先用 UIA 的 Invoke/Value/Toggle 等模式执行（稳定性优于坐标点击）。
- UIA 失败：尝试 OCR 定位关键文本（按钮文字/标签）。
- OCR 失败：仅在满足强约束时允许坐标兜底：
  - 目标窗口已置前且位置/大小固定（或可推导）
  - 分辨率/DPI/多屏布局固定
  - 每次坐标动作前后必须采集证据（截图/窗口矩形/断言）

### 4.2 “确保窗口正确”的硬性要求

任何动作前都应执行 `EnsureWindow`：

1) 置前：`desktop switch`
2) 校验：`desktop state`/`desktop ui-find`
3) 若定位坐标：校验坐标落在目标窗口矩形内（编排器应执行该校验）

## 5. 多屏 / DPI / 前台焦点限制（关键注意事项）

### 5.1 坐标系：Virtual Screen

多屏情况下，Windows 采用“虚拟桌面坐标系”（Virtual Screen）：

- 主屏未必在 (0,0)
- 其他屏幕可能在负坐标区域

因此：

- 所有坐标点击都必须明确使用“虚拟坐标系”理解
- 建议通过“窗口矩形 + 相对偏移”计算坐标，而不是写死绝对坐标

### 5.2 DPI 缩放

不同缩放比例会导致：

- UI 显示尺寸变化
- OCR 识别结果与坐标偏移变化

建议：

- 自动化测试机固定缩放（例如 100% 或 125%）
- 或在 UI Contract 中记录适配规则（例如按窗口矩形比例定位）

### 5.3 SetForegroundWindow 限制

Windows 对“抢前台窗口”有系统级限制（防止后台应用强制抢焦点）。实际表现：

- `desktop switch` 可能失败或延迟生效
- 必须在每步前后用 `desktop state` 进行确认

## 6. 关联资料

- `docs/reference/2026-02-03-桌面自动化点击与输入测试流程.md`：点击/输入测试闭环与证据建议
- `docs/reference/2026-02-03-UIContract与对象库规范.md`：对象库规范与 AI 编译规则
