# 2026-02-02：测试分组与运行方式（避免桌面抢焦点）

## 目标

让测试在不同环境下可控运行：

- 默认：只跑“无桌面副作用”的测试；
- 需要时：你可以手动选择跑哪些“会抢焦点/会操作鼠标键盘/会打开应用”的测试。

## 当前分组（xUnit Trait）

本仓库已为 `Windows.Agent.Test` 中的测试加了 `Trait("Category", "...")`：

- `Category=Desktop`：涉及鼠标/键盘/窗口/打开应用/截图/打开浏览器等，**会抢焦点**。
- `Category=SystemControl`：调节音量/亮度/分辨率等，**有系统副作用**。
- `Category=OCR`：OCR 相关（可能需要模型/依赖），通常不抢焦点但较重。
- `Category=FileSystem`：文件系统相关（会创建/删除临时文件）。

此外：

- `Windows.Agent.Cli.Test`：通过 mock `Windows.Agent.Interface.*` 验证 CLI 调度，不进行桌面操作。

## 推荐运行方式

### 1) 只跑 CLI 调度单测（最安全）

```bash
dotnet test src/Windows.Agent.Cli.Test/Windows.Agent.Cli.Test.csproj -c Release
```

### 2) 跑文件系统测试（不抢焦点）

```bash
dotnet test src/Windows.Agent.Test/Windows.Agent.Test.csproj -c Release --filter "Category=FileSystem"
```

> 说明：已将 `GetFileInfoToolTest` 等路径从 `C:\temp` 改为 `Path.GetTempPath()` 下，避免权限问题。

### 3) 选择性运行会抢焦点的 Desktop 测试（你手动决定）

```bash
dotnet test src/Windows.Agent.Test/Windows.Agent.Test.csproj -c Release --filter "Category=Desktop"
```

### 4) 排除 Desktop/SystemControl/OCR（仅跑“相对安全”的）

```bash
dotnet test src/Windows.Agent.Test/Windows.Agent.Test.csproj -c Release --filter "Category!=Desktop&Category!=SystemControl&Category!=OCR"
```

## Desktop 测试清单（会抢焦点）

位于 `src/Windows.Agent.Test/Desktop/`：

- `src/Windows.Agent.Test/Desktop/ClickToolTest.cs`
- `src/Windows.Agent.Test/Desktop/TypeToolTest.cs`
- `src/Windows.Agent.Test/Desktop/TypeToolTestV2.cs`
- `src/Windows.Agent.Test/Desktop/DragToolTest.cs`
- `src/Windows.Agent.Test/Desktop/MoveToolTest.cs`
- `src/Windows.Agent.Test/Desktop/ScrollToolTest.cs`
- `src/Windows.Agent.Test/Desktop/ShortcutToolTest.cs`
- `src/Windows.Agent.Test/Desktop/KeyToolTest.cs`
- `src/Windows.Agent.Test/Desktop/ClipboardToolTest.cs`
- `src/Windows.Agent.Test/Desktop/LaunchToolTest.cs`
- `src/Windows.Agent.Test/Desktop/SwitchToolTest.cs`（如果后续补齐/存在）
- `src/Windows.Agent.Test/Desktop/ResizeToolTest.cs`
- `src/Windows.Agent.Test/Desktop/GetWindowInfoToolTest.cs`
- `src/Windows.Agent.Test/Desktop/WaitToolTest.cs`
- `src/Windows.Agent.Test/Desktop/ScreenshotToolTest.cs`
- `src/Windows.Agent.Test/Desktop/OpenBrowserToolTest.cs`
- `src/Windows.Agent.Test/Desktop/ScrapeToolTest.cs`
- `src/Windows.Agent.Test/Desktop/PowershellToolTest.cs`
- `src/Windows.Agent.Test/Desktop/UIElementToolTest.cs`

## SystemControl 说明（会改系统设置，但应自动还原）

位于 `src/Windows.Agent.Test/SystemControl/`：

- 这些测试会真实修改：音量/静音、亮度、分辨率。
- 已增加“测试结束自动还原”逻辑（即使测试失败也会尽量恢复）。
- 已禁用并行执行（同一 collection，避免互相干扰）。
