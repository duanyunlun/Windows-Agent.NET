# 2026-02-03：桌面自动化「点击/输入」测试流程（Windows.Agent）

## 目标

说明在当前 `Windows.Agent` 代码结构下，如何把“自动化点击/输入”做成**可运行、可审计、可控副作用**的测试（主要针对 `Category=Desktop`）。

> 说明：本项目的 Desktop 能力会真实操作鼠标/键盘并抢夺焦点，因此此类测试更接近 **Integration Test**，默认不建议在日常全量测试里跑。

## 当前实现的真实执行链路（基于代码）

从测试/CLI 到 Windows 的输入注入，链路如下：

1. 测试（`Windows.Agent.Test`）或 CLI（`Windows.Agent.Cli`）调用 Tool（例如 `ClickTool` / `TypeTool`）
2. Tool 调用 `IDesktopService`（实现为 `DesktopService`）
3. `DesktopService` 通过 Win32 API 注入输入：
   - 点击：`SetCursorPos` + `mouse_event`（见 `src/Windows.Agent/Services/DesktopService.cs:709`）
   - 输入：先 `ClickAsync` 聚焦，再用 `SendInput`（`KEYEVENTF_UNICODE`）逐字符发送（见 `src/Windows.Agent/Services/DesktopService.cs:745`、`src/Windows.Agent/Services/DesktopService.cs:1450`）
   - 快捷键：仅内置支持 `ctrl/alt/shift` 三类修饰键 + 常见按键名（见 `src/Windows.Agent/Services/DesktopService.cs:1044`、`src/Windows.Agent/Services/DesktopService.cs:1475`）

关键点：

- **输入注入总是作用在“当前获得焦点的窗口/控件”**，因此测试必须先确保目标窗口在前台且输入焦点正确。
- 当前 `UIElementTool` 的 `automationId` 是窗口句柄 `hWnd.ToString()`（顶层窗口枚举），并非 Windows UI Automation 的 AutomationId（见 `src/Windows.Agent/Services/DesktopService.cs:1640`）。

## 推荐的 Desktop 自动化测试流程（稳定性优先）

### A. 选择“可控目标”

要做“可验证”的点击/输入测试，需要一个可控的目标窗口/控件（建议优先级）：

1. **推荐（长期）：专用 Test Target App**（最稳定、可断言、可无弹窗退出）
2. **可用（短期）：系统自带应用（如记事本）**（但可能遇到语言/版本差异、退出保存弹窗）

### B. 测试步骤模板（适用于 xUnit / CLI）

1. **准备/隔离环境**
   - 建议在空闲的 Windows 机器/VM 运行，避免人机同时抢输入。
   - 尽量固定主屏幕/缩放比例/分辨率（坐标依赖环境）。
2. **启动目标应用**
   - 通过 `desktop launch` 或测试内 `Process.Start` 启动。
3. **把窗口置前 & 固定窗口位置/大小**
   - 用 `desktop switch` + `desktop resize` 把窗口固定到可预测坐标（避免因窗口位置变化导致点击坐标失效）。
4. **聚焦到输入区域**
   - 使用 `desktop click` 点击输入区域中心点（坐标通常用“窗口左上角 + 偏移”计算）。
5. **执行输入**
   - 使用 `desktop type` 或 Tool 直接调用。
6. **断言（必须）**
   - 推荐用“复制到剪贴板 -> 读取剪贴板”作为断言通道：`ctrl+a`、`ctrl+c` -> `desktop clipboard --mode paste`
   - 或使用：窗口标题/进程存在/文件输出等“可读回”的状态做断言
7. **清理/恢复**
   - 关闭目标应用（避免残留窗口）
   - 尽最大努力恢复：剪贴板内容（Desktop 类不强制，但建议做）

## 一套可手工复现的 CLI 流程（示例）

以下示例用于理解“点击/输入/断言”的完整闭环；所有 Desktop 命令都需要显式 `--dangerous`：

1) 启动记事本：

```bash
windows-agent --dangerous desktop launch --name notepad
```

2) 等待窗口稳定（仅示例）：

```bash
windows-agent --dangerous desktop wait --seconds 1
```

3) 在记事本窗口内点击一个大致安全的坐标（你需要按自己的分辨率调整坐标）：

```bash
windows-agent --dangerous desktop click --x 200 --y 200
```

4) 输入文本：

```bash
windows-agent --dangerous desktop type --x 200 --y 200 --text \"Windows.Agent Desktop Test\" --clear
```

5) 全选复制（通过快捷键），再读取剪贴板用于断言：

```bash
windows-agent --dangerous desktop shortcut --keys \"ctrl+a\"
windows-agent --dangerous desktop shortcut --keys \"ctrl+c\"
windows-agent --dangerous desktop clipboard --mode paste
```

> 提示：如你发现 `desktop shortcut --keys \"win+r\"` 之类无效，这是因为当前实现仅内置支持 `ctrl/alt/shift` 三类修饰键。

## xUnit Desktop 测试的“推荐结构”

### 1) 分类与并行控制

- 统一标记：`[Trait(\"Category\", \"Desktop\")]`
- 建议放入同一 collection 并禁用并行（避免鼠标键盘注入互相干扰）

### 2) 断言与恢复

建议遵循以下原则：

- 断言必须基于“可读回”的状态（剪贴板/文件/窗口信息），不要只断言“返回字符串非空”。
- 用 `try/finally` 做清理，失败也要尽最大努力恢复。

## 常见现象与原因

- **跑 Desktop 测试时焦点被抢**：这是输入注入的必然结果（`SendInput/mouse_event` 作用于前台输入队列）。
- **跑测试时出现短暂黑屏/闪屏**：通常来自 `SystemControl` 分辨率切换测试（`ChangeDisplaySettings`），与 OCR 无直接关系。
  - 参考：`src/Windows.Agent.Test/SystemControl/ResolutionToolTest.cs`

## 关联资料

- `docs/reference/2026-02-02-测试运行速查.md`：如何用 `--filter` 选择性运行 Desktop/SystemControl/OCR/FileSystem 测试
- `docs/reference/2026-02-02-CLI命令速查.md`：CLI 命令参数速查（含 `windows-agent`/`wa`）

