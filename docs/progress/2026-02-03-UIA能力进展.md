# 2026-02-03：UIA 能力进展（Windows.Agent）

## 本次目标

- 落地 Phase 4 的基础 UIA 能力：控件树/唯一定位/Invoke/Value。
- 保持 CLI 输出统一 schema 与安全策略（高危操作需 `--dangerous`）。
- 补齐可手动运行的 Desktop 集成测试（会抢焦点，由你自行跑）。

## 已完成

### UIA 能力（FlaUI UIA3）

- 新增 UIA selector（字符串）解析：`automationId/name/className/controlType`（`key=value;key=value`）
- 新增 UIA Service + Tool：
  - `src/Windows.Agent/Services/UiaService.cs`
  - `src/Windows.Agent/Tools/Desktop/UiaTool.cs`
- CLI 新增命令（desktop 组）：
  - `desktop uia-tree --window <titleRegex> [--depth <int>]`
  - `desktop uia-find --window <titleRegex> --selector <string> [--limit <int>]`
  - `desktop uia-invoke --window <titleRegex> --selector <string>`（需要 `--dangerous`）
  - `desktop uia-setvalue --window <titleRegex> --selector <string> --value <string>`（需要 `--dangerous`）

### 工程调整（解决依赖匹配问题）

- 所有项目 TFM 收敛为 `net10.0-windows`，避免 UIA 相关包回退到 .NET Framework 资产（NU1701）。

### 测试

- CLI 单测增加覆盖：
  - `desktop uia-tree` 的调度（mock `IUiaService`）
  - `desktop uia-find` selector 解析（mock 参数断言）
  - `desktop uia-invoke` 缺少 `--dangerous` 的策略拒绝
- 新增 Desktop 集成测试目标 App 与用例：
  - `src/Windows.Agent.UiaTestApp/*`
  - `src/Windows.Agent.Test/Desktop/UiaToolTest.cs`（启动 test app，执行 setvalue/invoke，断言输出文件）

## 验证（本机执行）

1) CLI 单测（安全）：

```powershell
dotnet test src/Windows.Agent.Cli.Test/Windows.Agent.Cli.Test.csproj -c Release
```

结果：通过（15 tests）。

2) FileSystem 分类测试（不抢焦点）：

```powershell
dotnet test src/Windows.Agent.Test/Windows.Agent.Test.csproj -c Release --filter "Category=FileSystem"
```

结果：通过（90 tests）。

3) Desktop（UIA）集成测试（会抢焦点，你手动跑）：

```powershell
dotnet test src/Windows.Agent.Test/Windows.Agent.Test.csproj -c Release --filter "Category=Desktop" --logger "console;verbosity=detailed"
```

> 注意：该组会打开 `Windows.Agent.UiaTestApp` 窗口并执行 UIA/输入注入，跑之前请确保机器空闲、避免误操作。

## 待办（下一步）

- `desktop uia-find` 输出字段补齐并稳定化（`isOffscreen` 等已具备，后续可补 `processId/nativeHandle/runtimeId`）
- UI Contract 编排：从 UI Contract 直接生成 uia-find/uia-invoke/uia-setvalue 的可执行步骤（`run`/`validate` 增强）
- 诊断能力：`diag eventlog/collect`、失败时更多证据包采集（与 `--snapshot-on-error` 协同）

