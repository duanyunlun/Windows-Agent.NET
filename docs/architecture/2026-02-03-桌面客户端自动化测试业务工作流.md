# 2026-02-03：桌面客户端自动化测试业务工作流（Windows.Agent）

## 1. 定位：执行器 vs 编排器

在本仓库当前架构下，真实业务形态应明确拆分为两层：

- **Windows.Agent CLI（执行器 / Actuator）**：运行在“被测的那台 Windows 机器”上，负责执行动作（启动/切换窗口、点击、输入、截图、OCR、读写文件、调系统设置等），并输出结构化结果与证据（stdout JSON + 可选 artifacts）。
- **AI/大模型（编排器 / Orchestrator）**：读取用例/手册/约束，生成可执行步骤序列，逐步调用 CLI，做每步的校验、重试、回滚、证据收集与最终报告。

> 重要：Windows.Agent 不负责“理解自然语言并决定怎么点哪里”，它负责“把指令可靠地执行并反馈可审计结果”。自然语言到指令的映射属于编排器的职责。

## 2. 输入：用例、手册、契约与环境约束

业务上常见输入组合：

1) **自然语言测试用例**：例如“一、打开 A；二、点击登录；三、输入账号密码；四、校验提示……”
2) **用户手册**：描述页面/控件用途、理想流程、输入/输出与异常
3) **UI Contract（对象库/控件库）**：把“自然语言里提到的控件”结构化为可定位的信息（UIA/OCR/坐标），供编排器编译使用（详见 `docs/reference/2026-02-03-UIContract与对象库规范.md`）
4) **环境约束**（强影响稳定性）：
   - 分辨率/缩放（DPI）/多屏布局（Virtual Screen）
   - 权限（UAC/高完整性进程/安全桌面）
   - 机器是否有人操作（鼠标键盘抢占）
   - 被测应用 A 的语言/主题/布局版本差异

## 3. 输出：结构化结果 + 证据包（Artifacts）

输出分两类：

- **每步结构化结果（stdout JSON）**：用于编排器做判定（成功/失败/重试/下一步）
- **证据包（Artifacts）**：用于失败归因与报告（截图、桌面 state、窗口矩形、OCR 命中、日志 tail 等）

约定：

- stdout 只输出 JSON（便于 AI 解析）
- 日志写 stderr（避免污染 stdout）

## 4. 执行生命周期（推荐模板）

推荐把任何“点击/输入”等高副作用操作，拆成固定模板：

`EnsureWindow → ResolveElement → Act → Assert → Cleanup/Restore → Report`

### 4.1 EnsureWindow（确认窗口正确）

目标：每次操作前都确认“当前前台窗口是对的”，避免误点。

可用手段（按推荐顺序）：

1) `desktop switch`：尝试把目标窗口置前
2) `desktop state`：读取当前前台窗口标题（Focused App）+ 可见窗口列表（Opened Apps）
3) `desktop ui-find`：用更精确的标题片段/类名辅助确认（当前实现偏“顶层窗口枚举”）

### 4.2 ResolveElement（解析控件定位）

目标：把“要点的控件”解析成可以执行的定位信息（UIA/OCR/坐标）。

**定位策略优先级（默认）**：

1) **UIA（优先）**：适用于 WPF/WinUI/部分 WinForms/Win32 应用
2) **OCR**：适用于 Electron/Qt/自绘/控件无 UIA 信息的场景
3) **坐标（最后兜底）**：只在布局稳定、已强约束分辨率/缩放/窗口位置时使用

> 说明：当前仓库已有 OCR 与坐标点击能力；UIA 能力属于后续增强路线（见 `docs/plan/2026-02-02-路线图-按阶段.md` 的 Phase 4 拆解）。

### 4.3 Act（执行动作）

典型动作：

- 点击：`desktop click`
- 输入：`desktop type`
- 快捷键：`desktop shortcut`（当前仅内置支持 ctrl/alt/shift 修饰键）
- 调用模式（未来）：UIA 的 Invoke/Value/Toggle 等，优先于坐标 click

注意：

- Desktop 动作需要显式 `--dangerous`（避免误用）

### 4.4 Assert（后置断言）

断言必须基于“可读回”的证据，而不是只看“返回字符串不为空”。

建议断言来源（按推荐顺序）：

1) UIA 属性/状态（未来）
2) OCR `find/coords`（例如“登录成功”文本出现）
3) 剪贴板回读（例如输入后全选复制，再读取剪贴板）
4) 文件/日志（例如断言日志中出现某关键行）

### 4.5 Cleanup/Restore（清理与还原）

原则：

- 能自动还原的系统设置（音量/亮度/分辨率等）应在测试后恢复（本仓库 SystemControl 测试已按此处理）。
- Desktop 测试往往无法 100% 自动还原（例如焦点、窗口位置、剪贴板），应尽量清理并记录“未还原项”到报告。

### 4.6 Report（报告）

报告应包含：

- 每一步：输入（Step）、执行命令、stdout JSON、断言结果
- 失败时：证据包（截图/状态/日志 tail/窗口矩形等）与错误分层归因（详见 `docs/architecture/2026-02-03-错误观测与报告流水线.md`）

## 5. 稳定性与安全

### 5.1 `--dangerous` 的意义

Desktop/系统设置/执行命令等能力会带来强副作用与高风险：

- 误操作真实桌面（关闭窗口、点击错误按钮、输入到错误位置）
- 泄露隐私（截图、枚举窗口信息、读取剪贴板）
- 安全风险（PowerShell/打开浏览器/写文件）

因此 CLI 默认禁用高危命令，必须显式 `--dangerous` 才允许执行。

### 5.2 为什么 Desktop 测试默认不跑

因为它会：

- 抢焦点、干扰用户操作
- 受环境影响大（分辨率/缩放/多屏）
- 失败不可复现的概率更高

因此 Desktop 测试应被视为 Integration Test：默认不跑，由使用者按需手动执行（参考 `docs/reference/2026-02-02-测试运行速查.md`）。

### 5.3 UAC / 安全桌面限制（重要）

在 Windows 中：

- 低权限进程通常无法稳定自动化高权限窗口（UIA/输入注入都可能受限）
- UAC 弹窗在安全桌面，常规截图/输入注入可能失效

建议：自动化测试机应固定权限策略，或在测试策略中明确“遇到 UAC 弹窗时终止并报告”。

## 6. 失败分流：如何判断问题归属

推荐用“错误分层”做归因：

- **CliError**：CLI 自身崩溃/参数错误/策略拒绝（`--dangerous` 缺失）
- **LocateError**：窗口不对/元素找不到/坐标不在窗口内
- **ActError**：点击/输入执行失败或不生效
- **AssertError**：动作做了但断言不满足（业务失败）
- **AppError**：被测应用自身异常（崩溃/堆栈/日志报错）

详细流水线见：`docs/architecture/2026-02-03-错误观测与报告流水线.md`。

